---
title: "AFR Pheno file"
author: "Alex Flynn-Carroll"
date: "2025-12-13"
output: html_document
---

###############################################################################################
# library
###############################################################################################

```{r}

library(bigrquery)
library(tidyverse)
library(dplyr)
library(devtools)
library(data.table)

```

/mnt/arcus/lab/project/data/interim/batch1, /mnt/arcus/lab/project/data/interim/batch2

gs://scit1011-autism-gwas-b3-def/lab/output/lijj/20250626/

/mnt/arcus/data/manifests/file_manifest.csv


###############################################################################################
# read in data
###############################################################################################

```{r get project id}

bq_auth()
project_id <- bq_projects()[1]

```

```{r}

phecodes_count <- read.csv("../20250908_phenotypes_v2/phecodes_counts_by_indv.csv")

```

```{r read pc df}

pcs <- read.delim("../20251008_phewas_saige_pheno/atlas-onekg-pcs-ancestry.tsv", 
                 header = TRUE, 
                 stringsAsFactors = FALSE)


```

```{r get vcf individuals}

b1_s1 <- read.delim("/mnt/arcus/lab/project/data/interim/batch1/samples_3b4102e323.txt", 
                 header = F, 
                 stringsAsFactors = FALSE)

b1_s2 <- read.delim("/mnt/arcus/lab/project/data/interim/batch1/samples_eaa8d6126d.txt", 
                 header = F, 
                 stringsAsFactors = FALSE)

b1_s3 <- read.delim("/mnt/arcus/lab/project/data/interim/batch1/samples_34505c4e9a.txt", 
                 header = F, 
                 stringsAsFactors = FALSE)

b2_s1 <- read.delim("/mnt/arcus/lab/project/data/interim/batch2/samples_1c18651582.txt", 
                 header = F, 
                 stringsAsFactors = FALSE)

b2_s2 <- read.delim("/mnt/arcus/lab/project/data/interim/batch2/samples_e9229326cc.txt", 
                 header = F, 
                 stringsAsFactors = FALSE)

```

manifest to convert from pheno ids to geno ids
```{r manifest}

manifest <- read.csv("../20251008_phewas_saige_pheno/file_manifest.csv")

```

```{r}

age <- read.csv("../20250908_phenotypes_v2/max_phecode_age.csv")

colnames(age) <- c("pat_id", "age")

```

```{r}

query_patient <- "
SELECT
  pat_id,
  sex
FROM
  arcus.patient

"
patient_df <- bq_project_query(project_id, query_patient) %>%
  bq_table_download(bigint = "integer64") %>%
  as_tibble()

head(patient_df)

```

```{r icd to phecode map}

phecode_map <- read.csv("../20250801_arcus_phenotype_counts/Phecode_map_v1_2_icd9_icd10cm.csv")

```


###############################################################################################
# manifest information
###############################################################################################

```{r}

afr_bio <- pcs[pcs$ancestry == "AFR",]$IID

```

```{r}

array_list <- c("SCIT1011-AUTISM-GWAS_3b4102e323", "SCIT1011-AUTISM-GWAS_eaa8d6126d", "SCIT1011-AUTISM-GWAS_34505c4e9a", "SCIT1011-AUTISM-GWAS_1c18651582", "SCIT1011-AUTISM-GWAS_e9229326cc")

```

```{r}

manifest <- manifest[manifest$pat_id %in% phecodes_count$pat_id,]

#manifest <- manifest[manifest$filename %in% array_list,]

```

```{r}

manifest$biosample_id <- as.character(manifest$biosample_id)

```

```{r}

mani_ids <- unique(manifest[,c("pat_id", "biosample_id")])

```

```{r}

colnames(b1_s1) <- "biosample_id"

colnames(b1_s2) <- "biosample_id"

colnames(b1_s3) <- "biosample_id"

colnames(b2_s1) <- "biosample_id"

colnames(b2_s2) <- "biosample_id"

```

```{r}

b1_s1$biosample_id <- as.character(b1_s1$biosample_id )

b1_s2$biosample_id <- as.character(b1_s2$biosample_id )

b1_s3$biosample_id <- as.character(b1_s3$biosample_id )

b2_s1$biosample_id <- as.character(b2_s1$biosample_id )

b2_s2$biosample_id <- as.character(b2_s2$biosample_id )

```


```{r}

b1_s1 <- left_join(b1_s1, mani_ids, by = "biosample_id" )

b1_s2 <- left_join(b1_s2, mani_ids, by = "biosample_id" )

b1_s3 <- left_join(b1_s3, mani_ids, by = "biosample_id" )

```

```{r}

b2_s1 <- left_join(b2_s1, mani_ids, by = "biosample_id" )

b2_s2 <- left_join(b2_s2, mani_ids, by = "biosample_id" )


```

```{r}

b1_s1$array <- "3b4102e323"

b1_s2$array <- "eaa8d6126d"
  
b1_s3$array <- "34505c4e9a"
  
b2_s1$array <- "1c18651582"
  
b2_s2$array <- "e9229326cc"

```

```{r}

array_total <- rbind(b1_s1, b1_s2, b1_s3, b2_s1, b2_s2)

```

```{r}

array_afr_1 <- array_total[array_total$biosample_id %in% afr_bio,]

#array_afr_2 <- array_total[array_total$pat_id %in% afr_indv$IID,]

```

```{r}

array_afr_nmp <- array_afr_1[!is.na(array_afr_1$pat_id),]

```

# some entries have pat_ids as biosample ids
```{r}

array_afr_1_mpi <- subset(array_afr_1, is.na(pat_id) & grepl("^[A-Za-z]", biosample_id))

```

```{r}

array_afr_1_mpi$pat_id <- array_afr_1_mpi$biosample_id

```

```{r}

array_afr_total <- rbind(array_afr_nmp, array_afr_1_mpi)

```

###############################################################################################
# pcs df
###############################################################################################

```{r get df}

pc_join <- pcs[c("IID", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "ancestry")]

```

```{r}

colnames(pc_join) <- c("biosample_id", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "ancestry")


```

```{r}

array_afr_total <- left_join(array_afr_total, pc_join, by = "biosample_id")

```

###############################################################################################
# patient df
###############################################################################################

```{r}

patient_df$sex <- ifelse(patient_df$sex == "Male", 1,
                               ifelse(patient_df$sex == "Female", 2, NA))

```

###############################################################################################
# format phenos
###############################################################################################

```{r format df}

names(phecodes_count) <- gsub("^X", "", names(phecodes_count))

phecodes_count <- phecodes_count[, -1]

```

```{r change to binary}

phecodes_binary <- phecodes_count

phecodes_binary[, -1] <- ifelse(phecodes_count[,-1] >= 2, 1,
                         ifelse(phecodes_count[,-1] == 1, NA, 0))


```

```{r}

dup_array <- array_afr_total %>%
  group_by(pat_id) %>%
  filter(n() > 1) %>%
  ungroup()

```

```{r}

dup_array_prune <- dup_array %>%
  filter(!grepl("^[A-Za-z]", biosample_id))

```
dim(dup_array_prune)
 35 24

```{r}

dup_array_prune <- dup_array_prune %>%
  distinct(pat_id, .keep_all = TRUE)

```
dim(dup_array_prune)
[1] 153  24

```{r}

final_bio_afr <- array_afr_total %>%
  group_by(pat_id) %>%
  filter(n() == 1) %>%
  ungroup()

```

```{r}

final_bio_afr <- rbind(final_bio_afr, dup_array_prune)

```

###############################################################################################
# filter phenos by final afr list
###############################################################################################

length(unique(phecodes_binary$pat_id))
[1] 20489
```{r}

phecodes_binary_afr <- phecodes_binary[phecodes_binary$pat_id %in% final_bio_afr$pat_id,]

```
length(unique(phecodes_binary_afr$pat_id))
[1] 12726

```{r find number of phenotypes per cutoff}

col_sums <- colSums(phecodes_binary_afr[, -1], na.rm = T)

```

> sum(col_sums >= 100)
[1] 168

> sum(col_sums >= 200)
[1] 93

```{r subset to 200 phecodes}

cols_200 <- names(col_sums[col_sums >= 200])

# Subset the data (keep pat_id + qualifying phecodes)
phecodes_200 <- phecodes_binary_afr[, c("pat_id", cols_200)]

```

```{r}

phecode_map_200 <- phecode_map[phecode_map$Phecode %in% cols_200, ]

phecode_map_200 <- unique(phecode_map_200[,c("Phecode", "PhecodeString")])

```

```{r add age}

phecodes_200 <- left_join(phecodes_200, age, by = "pat_id")

```

```{r}

phecodes_200$age_sqr <- phecodes_200$age^2

```

```{r add sex}

phecodes_200 <- left_join(phecodes_200, patient_df, by = "pat_id")

```

```{r}

array_afr_total_phe_200 <- left_join(final_bio_afr, phecodes_200, by = "pat_id")

```

```{r}


array_afr_total_phe_200 <- array_afr_total_phe_200 %>%
  rename_with(~ ifelse(grepl("^[0-9]", .x), paste0("phe_", .x), .x))


```

```{r}

names(array_afr_total_phe_200)[names(array_afr_total_phe_200) == "biosample_id"] <- "IID"


```

```{r}

array_afr_total_phe_200 <- array_afr_total_phe_200 %>%
  mutate(array = factor(array)) %>%           # make sure it's a factor
  pivot_wider(
    names_from = array,
    values_from = array,
    values_fn = length,
    values_fill = 0
  )

```

```{r}
cols_to_change <- c("3b4102e323", "eaa8d6126d", "34505c4e9a", "1c18651582", "e9229326cc")
names(array_afr_total_phe_200)[names(array_afr_total_phe_200) %in% cols_to_change] <- paste0("array_", names(array_afr_total_phe_200)[names(array_afr_total_phe_200) %in% cols_to_change])


```


```{r}

write.csv(array_afr_total_phe_200, "afr_total_phe_200.csv")

```

```{r save pheno file in saige friendly format}

write.table(array_afr_total_phe_200, 
            file = "array_afr_total_phe_200.tsv", 
            sep = "\t", 
            quote = FALSE, 
            row.names = FALSE)


```

```{r save final list of afr indv for gwas}

# Write IDs to a file for vcftools
write.table(array_afr_total_phe_200$IID, 
            file = "afr_no_dup.txt", 
            quote = FALSE, 
            row.names = FALSE, 
            col.names = FALSE)


```

```{r}

array_afr_total_phe_200 <- read.csv("afr_total_phe_200.csv")

```

###############################################################################################
# get phecode names
###############################################################################################

```{r get list of phecodes}

phenotype_cols <- grep("^phe_", colnames(array_afr_total_phe_200), value = TRUE)


```

```{r}

writeLines(phenotype_cols[1:5], "phecodes_5.txt")

```
"/mnt/arcus/lab/users/flynncarra/projects/20251008_phewas_saige_pheno/phecodes_5.txt"

```{r}

# Compute column sums for these columns
phe_col_sums <- colSums(array_afr_total_phe_200[, phenotype_cols], na.rm = TRUE)

# Sort in descending order and take top 50
top50_cols <- names(sort(phe_col_sums, decreasing = TRUE))[1:50]

total_cols <- names(phe_col_sums)
  
```

```{r}

writeLines(top50_cols, "phecodes_t50.txt")

```

```{r}

writeLines(total_cols, "phecodes_200.txt")

```

###############################################################################################
# rolled up phenotype df
###############################################################################################

```{r}

covar_df <- array_afr_total_phe_200[,c("IID", "pat_id", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "ancestry", "age" , "sex", "age_sqr", "array_3b4102e323", "array_eaa8d6126d", "array_34505c4e9a", "array_1c18651582", "array_e9229326cc")]

```

```{r}

ru_phenos <- read.csv("../20250908_phenotypes_v2/phecodes_counts_by_indv_top.csv")

ru_phenos <- ru_phenos[, -1]

```

```{r}

colnames(ru_phenos) <- gsub("^X", "", names(ru_phenos))

colnames(ru_phenos)[-1] <- paste0("phe_", colnames(ru_phenos)[-1])

```

```{r}

ru_phenos[, -1] <- ifelse(ru_phenos[,-1] >= 2, 1,
                         ifelse(ru_phenos[,-1] == 1, NA, 0))


```

```{r}

ru_phenos <- ru_phenos[ru_phenos$pat_id %in% covar_df$pat_id, ]

```

```{r find number of phenotypes per cutoff}

col_sums_ru <- colSums(ru_phenos[, -1], na.rm = T)

```

> sum(col_sums_ru >= 200)
[1] 226

```{r subset to 200 phecodes}

cols_200_ru <- names(col_sums_ru[col_sums_ru >= 200])

# Subset the data (keep pat_id + qualifying phecodes)
phecodes_200_ru <- ru_phenos[, c("pat_id", cols_200_ru)]

```

```{r}

phecodes_200_ru_join <- ru_phenos[, c("pat_id", cols_200_ru)]

```


```{r}

phecodes_200_ru <- left_join(covar_df, phecodes_200_ru, by = "pat_id")

```

```{r}

writeLines(cols_200_ru, "phecodes_200_ru.txt")

```

```{r save rolled up pheno file in saige friendly format}

write.table(phecodes_200_ru, 
            file = "array_afr_total_phe_200_ru.tsv", 
            sep = "\t", 
            quote = FALSE, 
            row.names = FALSE)


```

```{r}

array_afr_total_phe_join <- array_afr_total_phe_200 %>%
  select(
    !starts_with("phe_"),
    matches("^phe_.*\\.")
  )

```

```{r}

array_afr_total_phe_join <- left_join(array_afr_total_phe_join, phecodes_200_ru_join, by = "pat_id")

```

```{r}

comb_cols <- array_afr_total_phe_join %>%
  select(starts_with("phe_")) %>%
  colnames()

```

```{r}

writeLines(comb_cols, "combined_columns.txt")

```

```{r save rolled up pheno file in saige friendly format}

write.table(array_afr_total_phe_join, 
            file = "array_afr_phe_200_comb.tsv", 
            sep = "\t", 
            quote = FALSE, 
            row.names = FALSE)


```

###############################################################################################
# make geno files
###############################################################################################

```{r}
cols <- c("array_3b4102e323", "array_eaa8d6126d", "array_34505c4e9a", "array_1c18651582", "array_e9229326cc")

any(rowSums(array_afr_total_phe_join[, cols] == 1, na.rm = TRUE) > 1)

```

```{r}

writeLines(as.character(array_afr_total_phe_join[array_afr_total_phe_join$array_3b4102e323 == 1,]$IID), "3b4102e323_id_sub.txt")

```

```{r}

writeLines(as.character(array_afr_total_phe_join[array_afr_total_phe_join$array_eaa8d6126d == 1,]$IID), "eaa8d6126d_id_sub.txt")

```

```{r}

writeLines(as.character(array_afr_total_phe_join[array_afr_total_phe_join$array_34505c4e9a == 1,]$IID), "34505c4e9a_id_sub.txt")

```

```{r}

writeLines(as.character(array_afr_total_phe_join[array_afr_total_phe_join$array_1c18651582 == 1,]$IID), "1c18651582_id_sub.txt")

```

```{r}

writeLines(as.character(array_afr_total_phe_join[array_afr_total_phe_join$array_e9229326cc == 1,]$IID), "e9229326cc_id_sub.txt")

```

