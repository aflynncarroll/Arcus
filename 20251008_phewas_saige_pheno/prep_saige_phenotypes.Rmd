---
title: "Curate Arcus Categorical Phenotypes"
output: html_document
date: "2025-10-08"
---

###############################################################################################
# library
###############################################################################################

```{r}

library(bigrquery)
library(tidyverse)
library(dplyr)
library(devtools)
library(data.table)

```

/mnt/arcus/lab/project/data/interim/batch1, /mnt/arcus/lab/project/data/interim/batch2

gs://scit1011-autism-gwas-b3-def/lab/output/lijj/20250626/

/mnt/arcus/data/manifests/file_manifest.csv


###############################################################################################
# read in data
###############################################################################################

```{r get project id}

bq_auth()
project_id <- bq_projects()[1]

```

```{r}

phecodes_count <- read.csv("../20250908_phenotypes_v2/phecodes_counts_by_indv.csv")

```

```{r}

file.copy(from = "/mnt/arcus/lab/project/data/interim/20250701B2/03_ancestry_calling/merge5arrays_NoCaseFilter/out_from_yi_run2/merged_a1.a2.a3.a4.a5/atlas-onekg-pcs-ancestry.tsv", 
          to = "/mnt/arcus/lab/users/flynncarra/projects/20251008_phewas_saige_pheno")


file.copy(from = "/mnt/arcus/lab/project/data/interim/20250701B2/03_ancestry_calling/merge5arrays_NoCaseFilter/out_from_yi_run2/merged_a1.a2.a3.a4.a5/atlas.EUR.list", 
          to = "/mnt/arcus/lab/users/flynncarra/projects/20251008_phewas_saige_pheno")
```

```{r read pc df}

pcs <- read.delim("atlas-onekg-pcs-ancestry.tsv", 
                 header = TRUE, 
                 stringsAsFactors = FALSE)


```

```{r read eur df}

eur_indv <- read.delim("atlas.EUR.list", 
                 header = TRUE, 
                 stringsAsFactors = FALSE)

```

```{r read anc dfs}

eur_indv <- read.delim("atlas.EUR.list", 
                 header = TRUE, 
                 stringsAsFactors = FALSE)

```

```{r save eur df for subsetting vcfs}

write.table(eur_indv["IID"],
            file = "eur_ids.txt",
            quote = FALSE,
            row.names = FALSE,
            col.names = FALSE)

# "/mnt/arcus/lab/users/flynncarra/projects/20251008_phewas_saige_pheno/eur_ids.txt"

```

```{r get vcf individuals}

b1_s1 <- read.delim("/mnt/arcus/lab/project/data/interim/batch1/samples_3b4102e323.txt", 
                 header = F, 
                 stringsAsFactors = FALSE)

b1_s2 <- read.delim("/mnt/arcus/lab/project/data/interim/batch1/samples_eaa8d6126d.txt", 
                 header = F, 
                 stringsAsFactors = FALSE)

b1_s3 <- read.delim("/mnt/arcus/lab/project/data/interim/batch1/samples_34505c4e9a.txt", 
                 header = F, 
                 stringsAsFactors = FALSE)

b2_s1 <- read.delim("/mnt/arcus/lab/project/data/interim/batch2/samples_1c18651582.txt", 
                 header = F, 
                 stringsAsFactors = FALSE)

b2_s2 <- read.delim("/mnt/arcus/lab/project/data/interim/batch2/samples_e9229326cc.txt", 
                 header = F, 
                 stringsAsFactors = FALSE)

```

manifest to convert from pheno ids to geno ids
```{r manifest}

manifest <- read.csv("file_manifest.csv")

```

```{r}

age <- read.csv("../20250908_phenotypes_v2/max_phecode_age.csv")

colnames(age) <- c("pat_id", "age")

```

```{r}

query_patient <- "
SELECT
  pat_id,
  sex
FROM
  arcus.patient

"
patient_df <- bq_project_query(project_id, query_patient) %>%
  bq_table_download(bigint = "integer64") %>%
  as_tibble()

head(patient_df)

```

```{r icd to phecode map}

phecode_map <- read.csv("../20250801_arcus_phenotype_counts/Phecode_map_v1_2_icd9_icd10cm.csv")

```


###############################################################################################
# manifest information
###############################################################################################


```{r}

array_list <- c("SCIT1011-AUTISM-GWAS_3b4102e323", "SCIT1011-AUTISM-GWAS_eaa8d6126d", "SCIT1011-AUTISM-GWAS_34505c4e9a", "SCIT1011-AUTISM-GWAS_1c18651582", "SCIT1011-AUTISM-GWAS_e9229326cc")

```

```{r}

manifest <- manifest[manifest$pat_id %in% phecodes_count$pat_id,]

#manifest <- manifest[manifest$filename %in% array_list,]

```

```{r}

manifest$biosample_id <- as.character(manifest$biosample_id)

```

```{r}

mani_ids <- unique(manifest[,c("pat_id", "biosample_id")])

```

```{r}

colnames(b1_s1) <- "biosample_id"

colnames(b1_s2) <- "biosample_id"

colnames(b1_s3) <- "biosample_id"

colnames(b2_s1) <- "biosample_id"

colnames(b2_s2) <- "biosample_id"

```

```{r}

b1_s1$biosample_id <- as.character(b1_s1$biosample_id )

b1_s2$biosample_id <- as.character(b1_s2$biosample_id )

b1_s3$biosample_id <- as.character(b1_s3$biosample_id )

b2_s1$biosample_id <- as.character(b2_s1$biosample_id )

b2_s2$biosample_id <- as.character(b2_s2$biosample_id )

```


```{r}

b1_s1 <- left_join(b1_s1, mani_ids, by = "biosample_id" )

b1_s2 <- left_join(b1_s2, mani_ids, by = "biosample_id" )

b1_s3 <- left_join(b1_s3, mani_ids, by = "biosample_id" )

```

```{r}

b2_s1 <- left_join(b2_s1, mani_ids, by = "biosample_id" )

b2_s2 <- left_join(b2_s2, mani_ids, by = "biosample_id" )


```

```{r}

b1_s1$array <- "3b4102e323"

b1_s2$array <- "eaa8d6126d"
  
b1_s3$array <- "34505c4e9a"
  
b2_s1$array <- "1c18651582"
  
b2_s2$array <- "e9229326cc"

```

```{r}

array_total <- rbind(b1_s1, b1_s2, b1_s3, b2_s1, b2_s2)

```

```{r}

array_eur_1 <- array_total[array_total$biosample_id %in% eur_indv$IID,]

#array_eur_2 <- array_total[array_total$pat_id %in% eur_indv$IID,]

```

```{r}

array_eur_nmp <- array_eur_1[!is.na(array_eur_1$pat_id),]

```

# some entries have pat_ids as biosample ids
```{r}

array_eur_1_mpi <- subset(array_eur_1, is.na(pat_id) & grepl("^[A-Za-z]", biosample_id))

```

```{r}

array_eur_1_mpi$pat_id <- array_eur_1_mpi$biosample_id

```

```{r}

array_eur_total <- rbind(array_eur_nmp, array_eur_1_mpi)

```

###############################################################################################
# pcs df
###############################################################################################

```{r get df}

pc_join <- pcs[c("IID", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "ancestry")]

```

```{r}

colnames(pc_join) <- c("biosample_id", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "PC11", "PC12", "PC13", "PC14", "PC15", "PC16", "PC17", "PC18", "PC19", "PC20", "ancestry")


```

```{r}

array_eur_total <- left_join(array_eur_total, pc_join, by = "biosample_id")

```

###############################################################################################
# patient df
###############################################################################################

```{r}

patient_df$sex <- ifelse(patient_df$sex == "Male", 1,
                               ifelse(patient_df$sex == "Female", 2, NA))

```

###############################################################################################
# format phenos
###############################################################################################

```{r format df}

names(phecodes_count) <- gsub("^X", "", names(phecodes_count))

phecodes_count <- phecodes_count[, -1]

```

```{r change to binary}

phecodes_binary <- phecodes_count

phecodes_binary[, -1] <- ifelse(phecodes_count[, -1] >= 2, 1, 0)

```

```{r}

dup_array <- array_eur_total %>%
  group_by(pat_id) %>%
  filter(n() > 1) %>%
  ungroup()

```

```{r}

dup_array_prune <- dup_array %>%
  filter(!grepl("^[A-Za-z]", biosample_id))

```
dim(dup_array_prune)
[1] 340  24

```{r}

dup_array_prune <- dup_array_prune %>%
  distinct(pat_id, .keep_all = TRUE)

```
dim(dup_array_prune)
[1] 153  24

```{r}

final_bio_eur <- array_eur_total %>%
  group_by(pat_id) %>%
  filter(n() == 1) %>%
  ungroup()

```

```{r}

final_bio_eur <- rbind(final_bio_eur, dup_array_prune)

```

###############################################################################################
# filter phenos by final eur list
###############################################################################################

length(unique(phecodes_binary$pat_id))
[1] 20489
```{r}

phecodes_binary_eur <- phecodes_binary[phecodes_binary$pat_id %in% final_bio_eur$pat_id,]

```
length(unique(phecodes_binary_eur$pat_id))
[1] 12726

```{r find number of phenotypes per cutoff}

col_sums <- colSums(phecodes_binary_eur[, -1])

```

> sum(col_sums >= 100)
[1] 360

> sum(col_sums >= 200)
[1] 226

```{r subset to 200 phecodes}

cols_200 <- names(col_sums[col_sums >= 200])

# Subset the data (keep pat_id + qualifying phecodes)
phecodes_200 <- phecodes_binary_eur[, c("pat_id", cols_200)]

```

```{r}

phecode_map_200 <- phecode_map[phecode_map$Phecode %in% cols_200, ]

phecode_map_200 <- unique(phecode_map_200[,c("Phecode", "PhecodeString")])

```

```{r add age}

phecodes_200 <- left_join(phecodes_200, age, by = "pat_id")

```

```{r}

phecodes_200$age_sqr <- phecodes_200$age^2

```

```{r add sex}

phecodes_200 <- left_join(phecodes_200, patient_df, by = "pat_id")

```

```{r}

array_eur_total_phe_200 <- left_join(final_bio_eur, phecodes_200, by = "pat_id")

```

```{r}


array_eur_total_phe_200 <- array_eur_total_phe_200 %>%
  rename_with(~ ifelse(grepl("^[0-9]", .x), paste0("phe_", .x), .x))


```

```{r}

names(array_eur_total_phe_200)[names(array_eur_total_phe_200) == "biosample_id"] <- "IID"


```

```{r}

array_eur_total_phe_200 <- array_eur_total_phe_200 %>%
  mutate(array = factor(array)) %>%           # make sure it's a factor
  pivot_wider(
    names_from = array,
    values_from = array,
    values_fn = length,
    values_fill = 0
  )

```

```{r}
cols_to_change <- c("3b4102e323", "eaa8d6126d", "34505c4e9a", "1c18651582", "e9229326cc")
names(array_eur_total_phe_200)[names(array_eur_total_phe_200) %in% cols_to_change] <- paste0("array_", names(array_eur_total_phe_200)[names(array_eur_total_phe_200) %in% cols_to_change])


```


```{r}

write.csv(array_eur_total_phe_200, "eur_total_phe_200.csv")

```

```{r save pheno file in saige friendly format}

write.table(array_eur_total_phe_200, 
            file = "array_eur_total_phe_200.tsv", 
            sep = "\t", 
            quote = FALSE, 
            row.names = FALSE)


```

```{r save final list of eur indv for gwas}

# Write IDs to a file for vcftools
write.table(array_eur_total_phe_200$IID, 
            file = "eur_no_dup.txt", 
            quote = FALSE, 
            row.names = FALSE, 
            col.names = FALSE)


```

```{r}

array_eur_total_phe_200 <- read.csv("eur_total_phe_200.csv")

```

###############################################################################################
# get phecode names
###############################################################################################

```{r get list of phecodes}

phenotype_cols <- grep("^phe_", colnames(array_eur_total_phe_200), value = TRUE)


```

```{r}

writeLines(phenotype_cols[1:5], "phecodes_5.txt")

```
"/mnt/arcus/lab/users/flynncarra/projects/20251008_phewas_saige_pheno/phecodes_5.txt"

```{r}

# Compute column sums for these columns
phe_col_sums <- colSums(array_eur_total_phe_200[, phenotype_cols], na.rm = TRUE)

# Sort in descending order and take top 50
top50_cols <- names(sort(phe_col_sums, decreasing = TRUE))[1:50]

total_cols <- names(phe_col_sums)
  
```

```{r}

writeLines(top50_cols, "phecodes_t50.txt")

```

```{r}

writeLines(total_cols, "phecodes_200.txt")

```

###############################################################################################
# make info df for pheweb
###############################################################################################

```{r get pheweb info}

top50_cols_df <- as.data.frame(top50_cols)

colnames(top50_cols_df) <- c("phenocode")

```

```{r}

top50_cols_df$phecode <- sub("^phe_", "", top50_cols_df$phenocode)

```

```{r}

# Convert named vector to data frame
colsums_df <- data.frame(
  phecode = names(col_sums),  # remove 'phe_' prefix
  num_cases = as.numeric(col_sums),
  row.names = NULL
)

top50_cols_df <- merge(top50_cols_df, colsums_df, by = "phecode", all.x = TRUE)

```

```{r}

top50_cols_df$num_samples <- nrow(array_eur_total_phe_200)

top50_cols_df$num_controls <- top50_cols_df$num_samples - top50_cols_df$num_cases

```

```{r}

top50_cols_df$assoc_files <- paste0("/mnt/arcus/lab/users/flynncarra/projects/20251016_SAIGE_t50_test/results/", top50_cols_df$phenocode, "_allchr.txt")

```

```{r add empty interaction column}

top50_cols_df$interaction <- ''

```

```{r}

colnames(phecode_map_200) <- c("phecode", "PhecodeString")

phecode_map_200$phecode <- as.character(phecode_map_200$phecode)

```

```{r}

top50_cols_df <- left_join(top50_cols_df,phecode_map_200, by = "phecode")

```

```{r}

names(top50_cols_df)[names(top50_cols_df) == "PhecodeString"] <- "phenostring"

```


```{r}

write.csv(top50_cols_df, row.names = F, file = "t50_file_manifest.csv")

```

"/mnt/arcus/lab/users/flynncarra/projects/20251008_phewas_saige_pheno/t50_file_manifest.csv"

###############################################################################################
# check output from saige
###############################################################################################

```{r}

saige_1002 <- read.table("/mnt/arcus/lab/users/flynncarra/projects/20251016_SAIGE_t50_test/results/phe_1002_allchr.txt", header = TRUE, sep = "\t", stringsAsFactors = FALSE)

```

###############################################################################################
# rolled up phenotype df
###############################################################################################

```{r}

covar_df <- array_eur_total_phe_200[,c("biosample_id", "pat_id", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10", "ancestry", "age" , "sex", "age_sqr", "array_3b4102e323", "array_eaa8d6126d", "array_34505c4e9a", "array_1c18651582", "array_e9229326cc")]

```

```{r}

ru_phenos <- read.csv("../20250908_phenotypes_v2/phecodes_counts_by_indv_ru.csv")

ru_phenos <- ru_phenos[, -1]

```

```{r}

colnames(ru_phenos) <- gsub("^X", "", names(ru_phenos))

colnames(ru_phenos)[-1] <- paste0("phe_", colnames(ru_phenos)[-1])

```

```{r}

ru_phenos[, -1] <- ifelse(ru_phenos[, -1] >= 2, 1, 0)

```

```{r}

ru_phenos <- ru_phenos[ru_phenos$pat_id %in% covar_df$pat_id, ]

```

```{r find number of phenotypes per cutoff}

col_sums_ru <- colSums(ru_phenos[, -1])

```

> sum(col_sums >= 100)
[1] 360

> sum(col_sums >= 200)
[1] 226

```{r subset to 200 phecodes}

cols_200_ru <- names(col_sums_ru[col_sums_ru >= 200])

# Subset the data (keep pat_id + qualifying phecodes)
phecodes_200_ru <- ru_phenos[, c("pat_id", cols_200_ru)]

```


```{r}

phecodes_200_ru <- left.join(covar_df, phecodes_200_ru, by = "pat_id")

```

```{r}

writeLines(cols_200_ru, "phecodes_200_ru.txt")

```

```{r save rolled up pheno file in saige friendly format}

write.table(phecodes_200_ru, 
            file = "array_eur_total_phe_200_ru.tsv", 
            sep = "\t", 
            quote = FALSE, 
            row.names = FALSE)


```